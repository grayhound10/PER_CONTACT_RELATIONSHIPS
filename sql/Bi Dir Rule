-- Bidirectional Relationship Rule (PER_CONTACT_RELATIONSHIPS)
--
-- Stakeholder summary:
-- A "bidirectional relationship" exists when the same two people are linked in both
-- directions. In plain terms: Person A has Person B as a contact, and Person B also
-- has Person A as a contact.
--
-- What this rule returns:
-- 1) Relationship rows where a reverse row exists.
-- 2) Pairs where both people are in the latest HR DQ_EXISTS cleanse batch for DQ_PERSON_ID.
-- 3) Pair keys, type meanings, and data quality flags for easier reporting.
--
-- Important interpretation note:
-- Each matched pair appears twice (A->B and B->A). Use DISTINCT on
-- (PAIR_LOW, PAIR_HIGH) if you need unique person pairs.

WITH latest_batch AS (
    SELECT MAX(BATCH_SEQ) AS BATCH_SEQ
    FROM DQ_CLEANSE_RESULTS
    WHERE DOMAIN_NAME = 'HR'
),
cleanse_people AS (
    SELECT DISTINCT CR.START_VALUE
    FROM DQ_CLEANSE_RESULTS CR
    JOIN latest_batch LB
      ON LB.BATCH_SEQ = CR.BATCH_SEQ
    WHERE CR.PROCEDURE_NAME = 'DQ_EXISTS'
      AND CR.FIELD_NAME = 'DQ_PERSON_ID'
)
SELECT
    LB.BATCH_SEQ AS BATCH_SEQ_USED,
    'DQ_BIDIR_REL' AS RULE_NAME,
    SYSTIMESTAMP AS QUERY_RUN_TS,
    T.PERSON_ID,
    T.CONTACT_PERSON_ID,
    T.CONTACT_TYPE AS PERSON_TO_CONTACT_TYPE,
    REV.CONTACT_TYPE AS CONTACT_TO_PERSON_TYPE,
    L1.MEANING AS PERSON_TO_CONTACT_TYPE_MEANING,
    L2.MEANING AS CONTACT_TO_PERSON_TYPE_MEANING,
    LEAST(T.PERSON_ID, T.CONTACT_PERSON_ID) AS PAIR_LOW,
    GREATEST(T.PERSON_ID, T.CONTACT_PERSON_ID) AS PAIR_HIGH,
    LEAST(T.PERSON_ID, T.CONTACT_PERSON_ID) || '-' ||
    GREATEST(T.PERSON_ID, T.CONTACT_PERSON_ID) AS PAIR_ID,
    T.DATE_START,
    T.DATE_END,
    CASE
        WHEN TRUNC(SYSDATE) BETWEEN NVL(T.DATE_START, DATE '1900-01-01')
                               AND NVL(T.DATE_END, DATE '4712-12-31')
        THEN 'Y'
        ELSE 'N'
    END AS ACTIVE_NOW_FLAG,
    CASE
        WHEN T.CONTACT_TYPE = REV.CONTACT_TYPE THEN 'Y'
        ELSE 'N'
    END AS SAME_TYPE_FLAG,
    CASE
        WHEN T.PERSON_ID = T.CONTACT_PERSON_ID THEN 'Y'
        ELSE 'N'
    END AS SELF_RELATIONSHIP_FLAG,
    COUNT(*) OVER (
        PARTITION BY T.PERSON_ID, T.CONTACT_PERSON_ID, T.CONTACT_TYPE
    ) AS DIRECTIONAL_DUP_COUNT,
    COUNT(*) OVER (
        PARTITION BY
            LEAST(T.PERSON_ID, T.CONTACT_PERSON_ID),
            GREATEST(T.PERSON_ID, T.CONTACT_PERSON_ID)
    ) AS PAIR_ROW_COUNT
FROM DQ_PER_CONTACT_RELATIONSHIPS_V T
JOIN DQ_PER_CONTACT_RELATIONSHIPS_V REV
  ON REV.PERSON_ID = T.CONTACT_PERSON_ID
 AND REV.CONTACT_PERSON_ID = T.PERSON_ID
JOIN latest_batch LB
  ON 1 = 1
LEFT JOIN APPS.FND_LOOKUP_VALUES L1
  ON L1.LOOKUP_CODE = T.CONTACT_TYPE
 AND L1.LOOKUP_TYPE = 'CONTACT'
 AND L1.ZD_EDITION_NAME = 'SET1'
LEFT JOIN APPS.FND_LOOKUP_VALUES L2
  ON L2.LOOKUP_CODE = REV.CONTACT_TYPE
 AND L2.LOOKUP_TYPE = 'CONTACT'
 AND L2.ZD_EDITION_NAME = 'SET1'
WHERE EXISTS (
    SELECT 1
    FROM cleanse_people CP
    WHERE CP.START_VALUE = TO_CHAR(T.PERSON_ID)
)
AND EXISTS (
    SELECT 1
    FROM cleanse_people CP
    WHERE CP.START_VALUE = TO_CHAR(T.CONTACT_PERSON_ID)
);
