-- PERSON_ID

SELECT 
    CONTACT_RELATIONSHIP_ID, 
    CONTACT_PERSON_ID, 
    CONTACT_TYPE, 
    DATE_START,
    CREATION_DATE
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE 
    PERSON_ID IS NULL;

SELECT CONTACT_RELATIONSHIP_ID, PERSON_ID, CONTACT_TYPE, CREATION_DATE
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE PERSON_ID < 0;

SELECT CONTACT_RELATIONSHIP_ID, PERSON_ID, CONTACT_TYPE, CREATION_DATE
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE PERSON_ID = 0;

SELECT
    COUNT(DISTINCT PERSON_ID) AS DISTINCT_PERSONS,
    COUNT(*) AS TOTAL_RECORDS,
    ROUND(COUNT(*) / NULLIF(COUNT(DISTINCT CONTACT_PERSON_ID), 0), 2) AS AVG_CONTACTS_PER_PERSON,
    MIN(PERSON_ID) AS MIN_PERSON_ID,
    MAX(PERSON_ID) AS MAX_PERSON_ID
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
-- Excesive Contacts?               
with base as (
SELECT 
    PERSON_ID, 
    COUNT(*) CONTACT_COUNT,
    COUNT(DISTINCT CONTACT_TYPE)  DISTINCT_TYPES
--    SUM(CASE WHEN DEPENDENT_FLAG = 'Y' THEN 1 ELSE 0 END) DEPENDENTS,
--    SUM(CASE WHEN BENEFICIARY_FLAG = 'Y' THEN 1 ELSE 0 END) BENEFICIARIES
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID
HAVING COUNT(*) > 10
ORDER BY CONTACT_COUNT DESC;
)

SELECT 
    *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND PERSON_ID = '453150'; 

-------------------------------------------------------------------------------
-- CONTACT_PERSON_ID

SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE CONTACT_PERSON_ID IS NULL;

SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE CONTACT_PERSON_ID < 0;

SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE CONTACT_PERSON_ID = 0;

-- Self-Referential Relationship (person = contact)
SELECT 
  *
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE PERSON_ID = CONTACT_PERSON_ID
AND PERSON_ID IS NOT NULL;

-- Contact Person Linked to Many Employees
SELECT 
    CONTACT_PERSON_ID, 
    COUNT(DISTINCT PERSON_ID) PERSONS
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_PERSON_ID
HAVING COUNT(DISTINCT PERSON_ID) > 1
ORDER BY PERSONS DESC;

-- BIDRIECTIONAL RELATIONSHIPS (Person References the other as contact)
SELECT
    PCR1.CONTACT_RELATIONSHIP_ID AS REL_A_TO_B,
    PCR2.CONTACT_RELATIONSHIP_ID AS REL_B_TO_A,
    PCR1.PERSON_ID AS PERSON_A,
    PCR1.CONTACT_PERSON_ID AS PERSON_B,
    PCR1.CONTACT_TYPE AS TYPE_A_TO_B,
    PCR2.CONTACT_TYPE AS TYPE_B_TO_A
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR1
JOIN APPS.PER_CONTACT_RELATIONSHIPS PCR2 ON PCR1.PERSON_ID = PCR2.CONTACT_PERSON_ID AND PCR1.CONTACT_PERSON_ID = PCR2.PERSON_ID
WHERE PCR1.CONTACT_RELATIONSHIP_ID < PCR2.CONTACT_RELATIONSHIP_ID
    AND TRUNC(SYSDATE) BETWEEN PCR1.DATE_START AND NVL(PCR1.DATE_END, DATE '4712-12-31')
    AND TRUNC(SYSDATE) BETWEEN PCR2.DATE_START AND NVL(PCR2.DATE_END, DATE '4712-12-31')
    AND EXISTS (
        SELECT 1 
        FROM DQ_PEOPLE_STATUS_V PS
        WHERE PS.PERSON_ID = PCR1.PERSON_ID
        AND PS.CATEGORY = 'ACTIVE_WORKERS'
    );

--SAME CONTACT_PERSON WITH MULTIPLE TYPES FOR SAME EMPLOYEE    
WITH BASE AS (
SELECT 
    PERSON_ID, 
    CONTACT_PERSON_ID,
    COUNT(DISTINCT CONTACT_TYPE) TYPE_COUNT,
    LISTAGG(DISTINCT CONTACT_TYPE, ', ') WITHIN GROUP (ORDER BY CONTACT_TYPE) AS CONTACT_TYPES,
    COUNT(*) AS TOTAL_RECORDS
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID, CONTACT_PERSON_ID
HAVING COUNT(DISTINCT CONTACT_TYPE) > 1
ORDER BY TYPE_COUNT DESC
)



SELECT 
    PERSON_ID,
    CONTACT_RELATIONSHIP_ID,
    CONTACT_PERSON_ID,
    CONTACT_TYPE,
    LKUP.MEANING,
    DATE_START,
    DATE_END
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
LEFT JOIN APPS.FND_LOOKUP_VALUES LKUP ON LKUP.LOOKUP_CODE = PCR.CONTACT_TYPE 
                                      AND LKUP.LOOKUP_TYPE = 'CONTACT'
                                      AND LKUP.ZD_EDITION_NAME = 'SET1'
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND EXISTS ( SELECT 1 FROM BASE B WHERE  B.PERSON_ID = PCR.PERSON_ID AND PCR.CONTACT_PERSON_ID = B.CONTACT_PERSON_ID);
--------------------------------------------------------------------------------
-- Contact types

SELECT
distinct
    NVL(CONTACT_TYPE, '(NULL)')  CONTACT_TYPE,
    LKUP.MEANING,
    LKUP.ENABLED_FLAG,
    COUNT(*) AS TOTAL_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
LEFT JOIN APPS.FND_LOOKUP_VALUES LKUP ON LKUP.LOOKUP_CODE = PCR.CONTACT_TYPE 
                                      AND LKUP.LOOKUP_TYPE = 'CONTACT'
                                      AND LKUP.ZD_EDITION_NAME = 'SET1'
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE, LKUP.MEANING, LKUP.ENABLED_FLAG
ORDER BY TOTAL_COUNT DESC;




--------------------------------------------------------------------------------    
 -- DATE START
 
SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    DATE_START IS NULL
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    DATE_START > SYSDATE
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
ORDER BY DATE_START DESC;

SELECT
    FLOOR(EXTRACT(YEAR FROM DATE_START) / 10) * 10 || 's' AS DECADE,
    COUNT(*) AS RECORD_COUNT,
    MIN(DATE_START) AS EARLIEST,
    MAX(DATE_START) AS LATEST
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY FLOOR(EXTRACT(YEAR FROM DATE_START) / 10) * 10
ORDER BY DECADE DESC;

-------------------------------------------------------------------------------
-- DATE END 

SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE DATE_END IS NOT NULL AND DATE_START IS NOT NULL AND DATE_END < DATE_START;

SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND DATE_END = DATE_START;
    
SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
   TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
AND ( NVL(DATE_END, DATE '4712-12-31') - DATE_START) BETWEEN 1 AND 7;
    
SELECT
    SUM(CASE WHEN DATE_END IS NULL THEN 1 ELSE 0 END) AS NULL_COUNT,
    SUM(CASE WHEN DATE_END IS NOT NULL THEN 1 ELSE 0 END) AS POPULATED_COUNT,
    COUNT(*) AS TOTAL_COUNT,
    ROUND(SUM(CASE WHEN DATE_END IS NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS NULL_PCT,
    ROUND(SUM(CASE WHEN DATE_END IS NOT NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS POPULATED_PCT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
-------------------------------------------------------------------------------

-- PRIMARY CONTACT FLAG

SELECT 
    *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND DATE_END IS NOT NULL;
    AND (PRIMARY_CONTACT_FLAG IS NULL OR PRIMARY_CONTACT_FLAG NOT IN ('Y', 'N'));
    
-- Multiple Active Primary Contacts per Person
SELECT PERSON_ID, 
       COUNT(*) AS PRIMARY_COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    PRIMARY_CONTACT_FLAG = 'Y'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID
HAVING COUNT(*) > 1
ORDER BY PRIMARY_COUNT DESC;

-- Primary Contact Flag Distribution
SELECT
    NVL(PRIMARY_CONTACT_FLAG, 'NULL') AS FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PRIMARY_CONTACT_FLAG
ORDER BY RECORD_COUNT DESC;

-- Persons with No Primary Contact
WITH BASE AS (
SELECT 
    PERSON_ID, 
    COUNT(*)  CONTACT_COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
   TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID
HAVING SUM(CASE WHEN PRIMARY_CONTACT_FLAG = 'Y' THEN 1 ELSE 0 END) = 0 AND COUNT(*) >= 1
ORDER BY CONTACT_COUNT DESC)

SELECT COUNT(DISTINCT PERSON_ID) FROM BASE;

SELECT 
    CONTACT_TYPE,
    SUM(CASE WHEN PRIMARY_CONTACT_FLAG = 'Y' THEN 1 ELSE 0 END) Y,
    SUM(CASE WHEN PRIMARY_CONTACT_FLAG = 'N' THEN 1 ELSE 0 END) N,
    SUM(CASE WHEN PRIMARY_CONTACT_FLAG IS NULL THEN 1 ELSE 0 END) "NULL",
    COUNT(*) AS TOTAL
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY Y DESC;

-------------------------------------------------------------------------------
-- DFFs populated?

SELECT ATTRIBUTE_NAME, POPULATED_COUNT,
    ROUND(POPULATED_COUNT * 100.0 / (SELECT COUNT(*) FROM APPS.PER_CONTACT_RELATIONSHIPS), 2) AS POP_PCT
FROM (
    SELECT 'CONT_ATTRIBUTE_CATEGORY' AS ATTRIBUTE_NAME, SUM(CASE WHEN CONT_ATTRIBUTE_CATEGORY IS NOT NULL THEN 1 ELSE 0 END) POPULATED_COUNT FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE1', SUM(CASE WHEN CONT_ATTRIBUTE1 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE2', SUM(CASE WHEN CONT_ATTRIBUTE2 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE3', SUM(CASE WHEN CONT_ATTRIBUTE3 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE4', SUM(CASE WHEN CONT_ATTRIBUTE4 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE5', SUM(CASE WHEN CONT_ATTRIBUTE5 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE6', SUM(CASE WHEN CONT_ATTRIBUTE6 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE7', SUM(CASE WHEN CONT_ATTRIBUTE7 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE8', SUM(CASE WHEN CONT_ATTRIBUTE8 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE9', SUM(CASE WHEN CONT_ATTRIBUTE9 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE10', SUM(CASE WHEN CONT_ATTRIBUTE10 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE11', SUM(CASE WHEN CONT_ATTRIBUTE11 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE12', SUM(CASE WHEN CONT_ATTRIBUTE12 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE13', SUM(CASE WHEN CONT_ATTRIBUTE13 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE14', SUM(CASE WHEN CONT_ATTRIBUTE14 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE15', SUM(CASE WHEN CONT_ATTRIBUTE15 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE16', SUM(CASE WHEN CONT_ATTRIBUTE16 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE17', SUM(CASE WHEN CONT_ATTRIBUTE17 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE18', SUM(CASE WHEN CONT_ATTRIBUTE18 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE19', SUM(CASE WHEN CONT_ATTRIBUTE19 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_ATTRIBUTE20', SUM(CASE WHEN CONT_ATTRIBUTE20 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
);

SELECT ATTRIBUTE_NAME, POPULATED_COUNT,
    ROUND(POPULATED_COUNT * 100.0 / (SELECT COUNT(*) FROM APPS.PER_CONTACT_RELATIONSHIPS), 2) AS POP_PCT
FROM (
    SELECT 'CONT_INFORMATION_CATEGORY' AS ATTRIBUTE_NAME, SUM(CASE WHEN CONT_INFORMATION_CATEGORY IS NOT NULL THEN 1 ELSE 0 END) POPULATED_COUNT FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION1', SUM(CASE WHEN CONT_INFORMATION1 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION2', SUM(CASE WHEN CONT_INFORMATION2 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION3', SUM(CASE WHEN CONT_INFORMATION3 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION4', SUM(CASE WHEN CONT_INFORMATION4 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION5', SUM(CASE WHEN CONT_INFORMATION5 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION6', SUM(CASE WHEN CONT_INFORMATION6 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION7', SUM(CASE WHEN CONT_INFORMATION7 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION8', SUM(CASE WHEN CONT_INFORMATION8 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION9', SUM(CASE WHEN CONT_INFORMATION9 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION10', SUM(CASE WHEN CONT_INFORMATION10 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION11', SUM(CASE WHEN CONT_INFORMATION11 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION12', SUM(CASE WHEN CONT_INFORMATION12 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION13', SUM(CASE WHEN CONT_INFORMATION13 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION14', SUM(CASE WHEN CONT_INFORMATION14 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION15', SUM(CASE WHEN CONT_INFORMATION15 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION16', SUM(CASE WHEN CONT_INFORMATION16 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION17', SUM(CASE WHEN CONT_INFORMATION17 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION18', SUM(CASE WHEN CONT_INFORMATION18 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION19', SUM(CASE WHEN CONT_INFORMATION19 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
    UNION ALL SELECT 'CONT_INFORMATION20', SUM(CASE WHEN CONT_INFORMATION20 IS NOT NULL THEN 1 ELSE 0 END) FROM APPS.PER_CONTACT_RELATIONSHIPS
);

-- Appears CONT_INFORMATION_CATEGORY is not null 
SELECT 
   DISTINCT CONT_INFORMATION_CATEGORY
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND CONT_INFORMATION_CATEGORY IS NOT NULL;            
    
-------------------------------------------------------------------------------

-- Personal flag column

SELECT CONTACT_RELATIONSHIP_ID, PERSON_ID, PERSONAL_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE PERSONAL_FLAG IS NOT NULL
AND PERSONAL_FLAG NOT IN ('Y', 'N');

SELECT
    NVL(PERSONAL_FLAG, 'NULL') AS FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSONAL_FLAG
ORDER BY RECORD_COUNT DESC;

SELECT 
    CONTACT_TYPE,
    SUM(CASE WHEN PERSONAL_FLAG = 'Y' THEN 1 ELSE 0 END) AS FLAG_Y,
    SUM(CASE WHEN PERSONAL_FLAG = 'N' THEN 1 ELSE 0 END) AS FLAG_N,
    SUM(CASE WHEN PERSONAL_FLAG IS NULL THEN 1 ELSE 0 END) AS FLAG_NULL,
    COUNT(*) AS TOTAL
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR 
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY TOTAL DESC;


SELECT
  PERSON_ID,
  CONTACT_PERSON_ID,
  CONTACT_TYPE,
  RLTD_PER_RSDS_W_DSGNTR_FLAG,
  PERSONAL_FLAG,
  DATE_START,
  DATE_END,
  CONTACT_RELATIONSHIP_ID
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
  RLTD_PER_RSDS_W_DSGNTR_FLAG = 'Y'
  AND PERSONAL_FLAG = 'N'
  AND 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
--------------------------------------------------------------------------------

-- Dependant Flag Column

SELECT CONTACT_RELATIONSHIP_ID, PERSON_ID, DEPENDENT_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    DEPENDENT_FLAG NOT IN ('Y', 'N')
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
SELECT
    NVL(DEPENDENT_FLAG, '(NULL)') FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2)  PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY DEPENDENT_FLAG
ORDER BY RECORD_COUNT DESC;

SELECT 
    CONTACT_TYPE,
    SUM(CASE WHEN DEPENDENT_FLAG = 'Y' THEN 1 ELSE 0 END)  DEP_Y,
    SUM(CASE WHEN DEPENDENT_FLAG = 'N' THEN 1 ELSE 0 END) DEP_N,
    SUM(CASE WHEN DEPENDENT_FLAG IS NULL THEN 1 ELSE 0 END) DEP_NULL,
    COUNT(*) AS TOTAL
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY DEP_Y DESC;

SELECT 
    PERSON_ID,
    COUNT(*) DEPENDENT_COUNT,
    LISTAGG(CONTACT_TYPE, ', ') WITHIN GROUP (ORDER BY CONTACT_TYPE)  CONTACT_TYPES
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    DEPENDENT_FLAG = 'Y'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID
HAVING COUNT(*) > 1
ORDER BY DEPENDENT_COUNT DESC;

--------------------------------------------------------------------------------
 -- BENEFICARY_FLAG 
SELECT 
    CONTACT_RELATIONSHIP_ID, 
    PERSON_ID, 
    BENEFICIARY_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
AND BENEFICIARY_FLAG NOT IN ('Y', 'N');

SELECT
    NVL(BENEFICIARY_FLAG, '(NULL)')FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY BENEFICIARY_FLAG
ORDER BY RECORD_COUNT DESC;

SELECT 
    CONTACT_TYPE,
    SUM(CASE WHEN BENEFICIARY_FLAG = 'Y' THEN 1 ELSE 0 END) AS BEN_Y,
    SUM(CASE WHEN BENEFICIARY_FLAG = 'N' THEN 1 ELSE 0 END) AS BEN_N,
    SUM(CASE WHEN BENEFICIARY_FLAG IS NULL THEN 1 ELSE 0 END) AS BEN_NULL,
    COUNT(*) AS TOTAL
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY BEN_Y DESC;

-- DEPENDANT without BENEFICARY (Potential Gap?)
SELECT 
    CONTACT_RELATIONSHIP_ID, 
    PERSON_ID, 
    CONTACT_TYPE, 
    DEPENDENT_FLAG, 
    BENEFICIARY_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    DEPENDENT_FLAG = 'Y'
    AND (BENEFICIARY_FLAG IS NULL OR BENEFICIARY_FLAG = 'N')
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
-- BENEFICARY BUT NOT DEPENDANT
SELECT 
    CONTACT_RELATIONSHIP_ID,
    PERSON_ID,
    CONTACT_TYPE, 
    DEPENDENT_FLAG, 
    BENEFICIARY_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    BENEFICIARY_FLAG = 'Y'
    AND DEPENDENT_FLAG = 'N'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
--------------------------------------------------------------------------------
-- THIRD PARTY PAY FLAG

SELECT 
    CONTACT_RELATIONSHIP_ID, 
    PERSON_ID, 
    THIRD_PARTY_PAY_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    THIRD_PARTY_PAY_FLAG NOT IN ('Y', 'N')
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
                 
SELECT 
    CONTACT_RELATIONSHIP_ID, 
    PCR.PERSON_ID, 
    PAPF.EMPLOYEE_NUMBER,
    THIRD_PARTY_PAY_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
LEFT JOIN APPS.PER_ALL_PEOPLE_F PAPF ON PAPF.PERSON_ID = PCR.PERSON_ID AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
WHERE 
    THIRD_PARTY_PAY_FLAG = 'Y'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');

SELECT
    NVL(THIRD_PARTY_PAY_FLAG, '(NULL)') FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2)  PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY THIRD_PARTY_PAY_FLAG;

SELECT CONTACT_TYPE, COUNT(*) AS TPP_COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    THIRD_PARTY_PAY_FLAG = 'Y'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY TPP_COUNT DESC;

-------------------------------------------------------------------------------
-- BONDHOLDER FLAG

SELECT 
    CONTACT_RELATIONSHIP_ID, 
    PERSON_ID,
    BONDHOLDER_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    BONDHOLDER_FLAG NOT IN ('Y', 'N')
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
SELECT
    NVL(BONDHOLDER_FLAG, '(NULL)') AS FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY BONDHOLDER_FLAG
ORDER BY RECORD_COUNT DESC;

SELECT 
    CONTACT_TYPE, 
    COUNT(*)  BH_COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    BONDHOLDER_FLAG = 'Y'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY BH_COUNT DESC;
-------------------------------------------------------------------------------
-- RLTD_PER_RSDS_W_DSGNTR_FLAG --

SELECT 
    CONTACT_RELATIONSHIP_ID, 
    PERSON_ID,
    RLTD_PER_RSDS_W_DSGNTR_FLAG
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    RLTD_PER_RSDS_W_DSGNTR_FLAG NOT IN ('Y', 'N')
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS');
                 
SELECT
    NVL(RLTD_PER_RSDS_W_DSGNTR_FLAG, '(NULL)') AS FLAG_VALUE,
    COUNT(*) AS RECORD_COUNT,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) AS PERCENTAGE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY RLTD_PER_RSDS_W_DSGNTR_FLAG
ORDER BY RECORD_COUNT DESC;

SELECT 
    CONTACT_TYPE, 
    COUNT(*)  COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    RLTD_PER_RSDS_W_DSGNTR_FLAG = 'Y'
    AND TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY CONTACT_TYPE
ORDER BY BH_COUNT DESC;



-------------------------------------------------------------------------------                    
-- COMMENTS

SELECT
    SUM(CASE WHEN COMMENTS IS NOT NULL THEN 1 ELSE 0 END) AS POPULATED,
    SUM(CASE WHEN COMMENTS IS NULL THEN 1 ELSE 0 END) AS NULL_COUNT,
    COUNT(*) AS TOTAL,
    ROUND(SUM(CASE WHEN COMMENTS IS NOT NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS POP_PCT
FROM APPS.PER_CONTACT_RELATIONSHIPS;

-- START LIFE
SELECT COUNT(*) AS POPULATED
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE START_LIFE_REASON_ID IS NOT NULL;

-- END LIFE
SELECT COUNT(*) AS POPULATED
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE END_LIFE_REASON_ID IS NOT NULL;

-- PARTY ID
SELECT COUNT(*) AS POPULATED
FROM APPS.PER_CONTACT_RELATIONSHIPS
WHERE PARTY_ID IS NOT NULL;

-------------------------------------------------------------------------------
-- EXACT DUPLICATES
SELECT 
    PERSON_ID, 
    CONTACT_PERSON_ID, 
    CONTACT_TYPE, 
    COUNT(*) AS DUP_COUNT,
    LISTAGG(CONTACT_RELATIONSHIP_ID, ', ') WITHIN GROUP (ORDER BY CONTACT_RELATIONSHIP_ID) REL_IDS
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE  
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID, CONTACT_PERSON_ID, CONTACT_TYPE, DATE_START
HAVING COUNT(*) > 1
ORDER BY DUP_COUNT DESC;

--OVERLAPPING DATE RANGES (Same relationship)
SELECT
    PCR1.CONTACT_RELATIONSHIP_ID AS REL_1,
    PCR2.CONTACT_RELATIONSHIP_ID AS REL_2,
    PCR1.PERSON_ID,
    PCR1.CONTACT_PERSON_ID,
    PCR1.CONTACT_TYPE,
    PCR1.DATE_START AS START_1, PCR1.DATE_END AS END_1,
    PCR2.DATE_START AS START_2, PCR2.DATE_END AS END_2
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR1
JOIN APPS.PER_CONTACT_RELATIONSHIPS PCR2
    ON PCR1.PERSON_ID = PCR2.PERSON_ID
    AND PCR1.CONTACT_PERSON_ID = PCR2.CONTACT_PERSON_ID
    --AND PCR1.CONTACT_TYPE = PCR2.CONTACT_TYPE
    AND PCR1.CONTACT_RELATIONSHIP_ID < PCR2.CONTACT_RELATIONSHIP_ID
WHERE 
    PCR1.DATE_START <= NVL(PCR2.DATE_END, TO_DATE('4712-12-31', 'YYYY-MM-DD'))
    AND NVL(PCR1.DATE_END, TO_DATE('4712-12-31', 'YYYY-MM-DD')) >= PCR2.DATE_START;
    
-- Multiple active contacts of same type

WITH BASE AS (
SELECT
    PERSON_ID,
    CONTACT_TYPE,
    COUNT(*) CONTACT_COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID,CONTACT_TYPE
HAVING COUNT(*) > 1
ORDER BY CONTACT_COUNT DESC
)

SELECT COUNT(DISTINCT PERSON_ID) FROM BASE;

SELECT 
    PCR.PERSON_ID,
    PERSON_PAPF.EMPLOYEE_NUMBER,
--    PERSON_PAPF.FIRST_NAME || ' ' || PERSON_PAPF.LAST_NAME AS PERSON_NAME,
--    CONTACT_PAPF.PERSON_ID CONTACT_PERSON_ID,
--    CONTACT_PAPF.FIRST_NAME || ' ' || CONTACT_PAPF.LAST_NAME AS CONTACT_NAME,
    PCR.CONTACT_RELATIONSHIP_ID,
    PCR.CONTACT_PERSON_ID,
    PCR.CONTACT_TYPE,
    LKUP.MEANING,
    PCR.DATE_START CONTACT_DATE_START,
    PCR.DATE_END   CONTACT_DATE_END,
    PCR.LAST_UPDATE_DATE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
LEFT JOIN APPS.PER_ALL_PEOPLE_F CONTACT_PAPF ON CONTACT_PAPF.PERSON_ID = PCR.CONTACT_PERSON_ID AND TRUNC(SYSDATE) BETWEEN CONTACT_PAPF.EFFECTIVE_START_DATE AND CONTACT_PAPF.EFFECTIVE_END_DATE
LEFT JOIN APPS.PER_ALL_PEOPLE_F PERSON_PAPF  ON PERSON_PAPF.PERSON_ID =  PCR.PERSON_ID AND TRUNC(SYSDATE) BETWEEN PERSON_PAPF.EFFECTIVE_START_DATE          AND PERSON_PAPF.EFFECTIVE_END_DATE
LEFT JOIN APPS.FND_LOOKUP_VALUES LKUP ON LKUP.LOOKUP_CODE = PCR.CONTACT_TYPE 
                                      AND LKUP.LOOKUP_TYPE = 'CONTACT'
                                      AND LKUP.ZD_EDITION_NAME = 'SET1'
WHERE 
   TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
   AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND PCR.PERSON_ID = '145913'
ORDER BY CONTACT_TYPE, DATE_START;

-- ALL FLAGS SET TO Y
SELECT *
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND PRIMARY_CONTACT_FLAG = 'Y'
    AND DEPENDENT_FLAG = 'Y'
    AND BENEFICIARY_FLAG = 'Y'
    AND THIRD_PARTY_PAY_FLAG = 'Y'
    AND BONDHOLDER_FLAG = 'Y';

-- CONFLICTING TYPES (e.g., SPOUSE and CHILD for same contact) 
SELECT 
PERSON_ID,
CONTACT_PERSON_ID,
LISTAGG(DISTINCT CONTACT_TYPE, ', ') WITHIN GROUP (ORDER BY CONTACT_TYPE) AS TYPES,
   CASE
       WHEN MAX(CASE WHEN CONTACT_TYPE IN ('S','DP') THEN 1 ELSE 0 END) = 1
        AND MAX(CASE WHEN CONTACT_TYPE IN ('C','A','SC','O') THEN 1 ELSE 0 END) = 1
       THEN 'Spouse + Child'
       WHEN MAX(CASE WHEN CONTACT_TYPE IN ('S','DP') THEN 1 ELSE 0 END) = 1
        AND MAX(CASE WHEN CONTACT_TYPE IN ('P') THEN 1 ELSE 0 END) = 1
       THEN 'Spouse + Parent'
       WHEN MAX(CASE WHEN CONTACT_TYPE IN ('S','DP') THEN 1 ELSE 0 END) = 1
        AND MAX(CASE WHEN CONTACT_TYPE IN ('T') THEN 1 ELSE 0 END) = 1
       THEN 'Spouse + Sibling'
       WHEN MAX(CASE WHEN CONTACT_TYPE IN ('P') THEN 1 ELSE 0 END) = 1
        AND MAX(CASE WHEN CONTACT_TYPE IN ('C','A','SC','O') THEN 1 ELSE 0 END) = 1
       THEN 'Parent + Child'
       WHEN MAX(CASE WHEN CONTACT_TYPE IN ('P') THEN 1 ELSE 0 END) = 1
        AND MAX(CASE WHEN CONTACT_TYPE IN ('T') THEN 1 ELSE 0 END) = 1
       THEN 'Parent + Sibling'
   END AS CONFLICT_TYPE
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
      AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID, CONTACT_PERSON_ID
HAVING
   -- Any of the impossible combinations
   (MAX(CASE WHEN CONTACT_TYPE IN ('S','DP') THEN 1 ELSE 0 END)
  + MAX(CASE WHEN CONTACT_TYPE IN ('C','A','SC','O') THEN 1 ELSE 0 END)
  + MAX(CASE WHEN CONTACT_TYPE IN ('P') THEN 1 ELSE 0 END)
  + MAX(CASE WHEN CONTACT_TYPE IN ('T') THEN 1 ELSE 0 END)) > 1
ORDER BY CONFLICT_TYPE, PERSON_ID;



-- PERSONS WITH ONLY EMERGENCY CONTACTS
WITH BASES AS (
SELECT 
    PERSON_ID, 
    COUNT(*)  CONTACT_COUNT
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE 
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
GROUP BY PERSON_ID
HAVING SUM(CASE WHEN UPPER(CONTACT_TYPE) IN ('EMRG') THEN 1 ELSE 0 END) = COUNT(*)
AND COUNT(*) >= 1
)

SELECT COUNT(DISTINCT PERSON_ID) FROM BASES;

SELECT
* 
FROM APPS.PER_CONTACT_RELATIONSHIPS PCR
WHERE
    TRUNC(SYSDATE) BETWEEN PCR.DATE_START AND NVL(PCR.DATE_END, DATE '4712-12-31')
    AND EXISTS ( SELECT 1 FROM DQ_PEOPLE_STATUS_V PS
                 WHERE PS.PERSON_ID = PCR.PERSON_ID
                 AND PS.CATEGORY = 'ACTIVE_WORKERS')
    AND PERSON_ID = 834;


SELECT 
    * 
FROM APPS.PER_CONTACT_RELATIONSHIPS 
WHERE RLTD_PER_RSDS_W_DSGNTR_FLAG = 'Y' and PERSONAL_FLAG= 'N';

    
