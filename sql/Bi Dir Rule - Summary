-- Bidirectional Relationships Rule - Count Summary
-- Direct query matching the Bi Dir Rule logic (no batch filter)
WITH bidir_pairs AS (
    SELECT
        T.PERSON_ID,
        T.CONTACT_PERSON_ID,
        T.CONTACT_TYPE AS PERSON_TO_CONTACT_TYPE,
        R.CONTACT_TYPE AS CONTACT_TO_PERSON_TYPE
    FROM DQ_PER_CONTACT_RELATIONSHIPS_V T
    JOIN APPS.PER_CONTACT_RELATIONSHIPS R
      ON R.PERSON_ID = T.CONTACT_PERSON_ID
     AND R.CONTACT_PERSON_ID = T.PERSON_ID
)
-- 1) Overall counts
SELECT
    'TOTAL' AS CATEGORY,
    NULL AS PERSON_TO_CONTACT_TYPE,
    NULL AS CONTACT_TO_PERSON_TYPE,
    COUNT(*) AS PAIR_COUNT,
    COUNT(DISTINCT PERSON_ID) AS DISTINCT_PERSONS,
    COUNT(DISTINCT CONTACT_PERSON_ID) AS DISTINCT_CONTACTS
FROM bidir_pairs
UNION ALL
-- 2) Breakdown by relationship type combination
SELECT
    'BY_TYPE_COMBO' AS CATEGORY,
    L1.MEANING AS PERSON_TO_CONTACT_TYPE,
    L2.MEANING AS CONTACT_TO_PERSON_TYPE,
    COUNT(*) AS PAIR_COUNT,
    COUNT(DISTINCT BP.PERSON_ID) AS DISTINCT_PERSONS,
    COUNT(DISTINCT BP.CONTACT_PERSON_ID) AS DISTINCT_CONTACTS
FROM bidir_pairs BP
LEFT JOIN APPS.FND_LOOKUP_VALUES L1
  ON L1.LOOKUP_CODE = BP.PERSON_TO_CONTACT_TYPE
 AND L1.LOOKUP_TYPE = 'CONTACT'
 AND L1.ZD_EDITION_NAME = 'SET1'
LEFT JOIN APPS.FND_LOOKUP_VALUES L2
  ON L2.LOOKUP_CODE = BP.CONTACT_TO_PERSON_TYPE
 AND L2.LOOKUP_TYPE = 'CONTACT'
 AND L2.ZD_EDITION_NAME = 'SET1'
GROUP BY L1.MEANING, L2.MEANING
ORDER BY CATEGORY, PAIR_COUNT DESC;
