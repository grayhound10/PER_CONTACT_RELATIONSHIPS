-- Bidirectional Relationships Rule - Count Summary
-- Aggregate view of DQ_BIDIR_REL hits from latest batch
WITH latest_batch AS (
    SELECT MAX(BATCH_SEQ) AS BATCH_SEQ
    FROM DQ_CLEANSE_RESULTS
    WHERE DOMAIN_NAME = 'HR'
),
cleanse_hits AS (
    SELECT R.TABROWID
    FROM DQ_CLEANSE_RESULTS R
    JOIN latest_batch LB ON LB.BATCH_SEQ = R.BATCH_SEQ
    WHERE R.PROCEDURE_NAME = 'DQ_EXISTS'
      AND R.FIELD_NAME = 'DQ_PERSON_ID'
      AND R.TABLE_NAME = 'PER_CONTACT_RELATIONSHIPS'
),
bidir_pairs AS (
    SELECT
        P1.PERSON_ID,
        P1.CONTACT_PERSON_ID,
        P1.CONTACT_TYPE AS PERSON_TO_CONTACT_TYPE,
        P2.CONTACT_TYPE AS CONTACT_TO_PERSON_TYPE
    FROM cleanse_hits CH
    JOIN DQ_PER_CONTACT_RELATIONSHIPS_V P1
      ON TO_CHAR(P1.TABROWID) = TO_CHAR(CH.TABROWID)
    JOIN DQ_PER_CONTACT_RELATIONSHIPS_V P2
      ON P2.PERSON_ID = P1.CONTACT_PERSON_ID
     AND P2.CONTACT_PERSON_ID = P1.PERSON_ID
)
-- 1) Overall counts
SELECT
    'TOTAL' AS CATEGORY,
    NULL AS PERSON_TO_CONTACT_TYPE,
    NULL AS CONTACT_TO_PERSON_TYPE,
    COUNT(*) AS PAIR_COUNT,
    COUNT(DISTINCT PERSON_ID) AS DISTINCT_PERSONS,
    COUNT(DISTINCT CONTACT_PERSON_ID) AS DISTINCT_CONTACTS
FROM bidir_pairs
UNION ALL
-- 2) Breakdown by relationship type combination
SELECT
    'BY_TYPE_COMBO' AS CATEGORY,
    L1.MEANING AS PERSON_TO_CONTACT_TYPE,
    L2.MEANING AS CONTACT_TO_PERSON_TYPE,
    COUNT(*) AS PAIR_COUNT,
    COUNT(DISTINCT BP.PERSON_ID) AS DISTINCT_PERSONS,
    COUNT(DISTINCT BP.CONTACT_PERSON_ID) AS DISTINCT_CONTACTS
FROM bidir_pairs BP
LEFT JOIN APPS.FND_LOOKUP_VALUES L1
  ON L1.LOOKUP_CODE = BP.PERSON_TO_CONTACT_TYPE
 AND L1.LOOKUP_TYPE = 'CONTACT'
 AND L1.ZD_EDITION_NAME = 'SET1'
LEFT JOIN APPS.FND_LOOKUP_VALUES L2
  ON L2.LOOKUP_CODE = BP.CONTACT_TO_PERSON_TYPE
 AND L2.LOOKUP_TYPE = 'CONTACT'
 AND L2.ZD_EDITION_NAME = 'SET1'
GROUP BY L1.MEANING, L2.MEANING
ORDER BY CATEGORY, PAIR_COUNT DESC;
