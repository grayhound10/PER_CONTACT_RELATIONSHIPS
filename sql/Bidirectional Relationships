WITH latest_batch AS (
    SELECT MAX(BATCH_SEQ) AS BATCH_SEQ
    FROM DQ_CLEANSE_RESULTS
    WHERE DOMAIN_NAME = 'HR'
),
hit_people AS (
    SELECT DISTINCT R.START_VALUE
    FROM DQ_CLEANSE_RESULTS R
    JOIN latest_batch LB
      ON LB.BATCH_SEQ = R.BATCH_SEQ
    WHERE R.PROCEDURE_NAME = 'DQ_EXISTS'
      AND R.FIELD_NAME = 'DQ_PERSON_ID'
),
bidir_pairs AS (
    SELECT
        P1.PERSON_ID,
        P1.CONTACT_PERSON_ID,
        P1.CONTACT_TYPE AS PERSON_TO_CONTACT_TYPE,
        P2.CONTACT_TYPE AS CONTACT_TO_PERSON_TYPE,
        P1.DATE_START,
        P1.DATE_END,
        P1.PRIMARY_CONTACT_FLAG,
        P1.PERSONAL_FLAG,
        P1.DEPENDENT_FLAG,
        P1.RLTD_PER_RSDS_W_DSGNTR_FLAG,
        P1.THIRD_PARTY_PAY_FLAG,
        P1.BONDHOLDER_FLAG,
        P1.BENEFICIARY_FLAG
    FROM DQ_PER_CONTACT_RELATIONSHIPS_V P1
    JOIN DQ_PER_CONTACT_RELATIONSHIPS_V P2
      ON P2.PERSON_ID = P1.CONTACT_PERSON_ID
     AND P2.CONTACT_PERSON_ID = P1.PERSON_ID
    JOIN hit_people H1
      ON H1.START_VALUE = TO_CHAR(P1.PERSON_ID)
    JOIN hit_people H2
      ON H2.START_VALUE = TO_CHAR(P1.CONTACT_PERSON_ID)
    WHERE P1.PERSON_ID < P1.CONTACT_PERSON_ID
)
SELECT
    BP.PERSON_ID,
    P1_PAPF.EMPLOYEE_NUMBER AS PERSON_EMPLOYEE_NUMBER,
    P1_PAPF.FULL_NAME AS PERSON_NAME,
    BP.CONTACT_PERSON_ID,
    P2_PAPF.EMPLOYEE_NUMBER AS CONTACT_EMPLOYEE_NUMBER,
    P2_PAPF.FULL_NAME AS CONTACT_NAME,
    BP.PERSON_TO_CONTACT_TYPE,
    L1.MEANING AS PERSON_TO_CONTACT_TYPE_MEANING,
    BP.CONTACT_TO_PERSON_TYPE,
    L2.MEANING AS CONTACT_TO_PERSON_TYPE_MEANING,
    COALESCE(P1_PAPF.FULL_NAME, TO_CHAR(BP.PERSON_ID)) ||
    ' <-> ' ||
    COALESCE(P2_PAPF.FULL_NAME, TO_CHAR(BP.CONTACT_PERSON_ID)) ||
    ' (' ||
    COALESCE(L1.MEANING, BP.PERSON_TO_CONTACT_TYPE) ||
    ' / ' ||
    COALESCE(L2.MEANING, BP.CONTACT_TO_PERSON_TYPE) ||
    ')' AS RELATIONSHIP_SUMMARY,
    BP.DATE_START,
    BP.DATE_END,
    BP.PRIMARY_CONTACT_FLAG,
    BP.PERSONAL_FLAG,
    BP.DEPENDENT_FLAG,
    BP.RLTD_PER_RSDS_W_DSGNTR_FLAG,
    BP.THIRD_PARTY_PAY_FLAG,
    BP.BONDHOLDER_FLAG,
    BP.BENEFICIARY_FLAG
FROM bidir_pairs BP
LEFT JOIN APPS.PER_ALL_PEOPLE_F P1_PAPF
  ON P1_PAPF.PERSON_ID = BP.PERSON_ID
 AND TRUNC(SYSDATE) BETWEEN P1_PAPF.EFFECTIVE_START_DATE AND P1_PAPF.EFFECTIVE_END_DATE
LEFT JOIN APPS.PER_ALL_PEOPLE_F P2_PAPF
  ON P2_PAPF.PERSON_ID = BP.CONTACT_PERSON_ID
 AND TRUNC(SYSDATE) BETWEEN P2_PAPF.EFFECTIVE_START_DATE AND P2_PAPF.EFFECTIVE_END_DATE
LEFT JOIN APPS.FND_LOOKUP_VALUES L1
  ON L1.LOOKUP_CODE = BP.PERSON_TO_CONTACT_TYPE
 AND L1.LOOKUP_TYPE = 'CONTACT'
 AND L1.ZD_EDITION_NAME = 'SET1'
LEFT JOIN APPS.FND_LOOKUP_VALUES L2
  ON L2.LOOKUP_CODE = BP.CONTACT_TO_PERSON_TYPE
 AND L2.LOOKUP_TYPE = 'CONTACT'
 AND L2.ZD_EDITION_NAME = 'SET1'
ORDER BY BP.PERSON_ID, BP.CONTACT_PERSON_ID;
