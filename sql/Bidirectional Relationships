insert into DQ_CLEANSE_RESULTS
               (CTRL_SEQ
               ,MASTER_CTRL_SEQ
               ,DQRULE_SEQ
               ,TABROWID
               ,PROCEDURE_NAME
               ,TABLE_NAME
               ,FIELD_NAME
               ,START_VALUE
               ,CLEANSED_VALUE
               )
               select 7831, 7821, 9047, TABROWID , 'DQ_EXISTS' , 'PER_CONTACT_RELATIONSHIPS' , 'DQ_PERSON_ID' ,  DQ_PERSON_ID,  DQ_PERSON_ID from DQ_PER_CONTACT_RELATIONSHIPS_V T where exists ( SELECT 1 FROM APPS.PER_CONTACT_RELATIONSHIPS R WHERE R.PERSON_ID = T.CONTACT_PERSON_ID AND R.CONTACT_PERSON_ID = T.PERSON_ID)


SELECT
        PAIR_GROUP,
        SIDE,
        PCR.PERSON_ID,
        PAPF.EMPLOYEE_NUMBER,
        PAPF.FULL_NAME,
        PCR.CONTACT_PERSON_ID,
        PCR.CONTACT_TYPE,
        LKUP.MEANING,
        PCR.DATE_START,
        PCR.DATE_END,
        PCR.PRIMARY_CONTACT_FLAG,
        PCR.PERSONAL_FLAG,
        PCR.DEPENDENT_FLAG,
        PCR.RLTD_PER_RSDS_W_DSGNTR_FLAG,
        THIRD_PARTY_PAY_FLAG,
        BONDHOLDER_FLAG,
        BENEFICIARY_FLAG
FROM (
        -- Row 1: The person who created the contact relationship
        SELECT PCR1.*,
               PCR1.PERSON_ID AS PAIR_GROUP,
               1 AS SIDE
        FROM DQ_PER_CONTACT_RELATIONSHIPS_V PCR1
        WHERE EXISTS (SELECT 1 FROM DQ_CLEANSE_RESULTS R
                      WHERE R.START_VALUE = PCR1.PERSON_ID
                      AND R.PROCEDURE_NAME = 'DQ_EXISTS'
                      AND R.FIELD_NAME = 'DQ_PERSON_ID'
                      AND R.BATCH_SEQ = (SELECT MAX(BATCH_SEQ) FROM DQ_CLEANSE_RESULTS WHERE DOMAIN_NAME = 'HR'))

        UNION ALL

        -- Row 2: The reciprocal relationship (contact person listing the original person)
        SELECT PCR2.*,
               PCR2.CONTACT_PERSON_ID AS PAIR_GROUP,
               2 AS SIDE
        FROM DQ_PER_CONTACT_RELATIONSHIPS_V PCR2
        WHERE EXISTS (SELECT 1 FROM DQ_CLEANSE_RESULTS R
                      WHERE R.START_VALUE = PCR2.CONTACT_PERSON_ID
                      AND R.PROCEDURE_NAME = 'DQ_EXISTS'
                      AND R.FIELD_NAME = 'DQ_PERSON_ID'
                      AND R.BATCH_SEQ = (SELECT MAX(BATCH_SEQ) FROM DQ_CLEANSE_RESULTS WHERE DOMAIN_NAME = 'HR'))
        AND PCR2.PERSON_ID IN (SELECT PCR3.CONTACT_PERSON_ID
                                FROM DQ_PER_CONTACT_RELATIONSHIPS_V PCR3
                                WHERE EXISTS (SELECT 1 FROM DQ_CLEANSE_RESULTS R
                                              WHERE R.START_VALUE = PCR3.PERSON_ID
                                              AND R.PROCEDURE_NAME = 'DQ_EXISTS'
                                              AND R.FIELD_NAME = 'DQ_PERSON_ID'
                                              AND R.BATCH_SEQ = (SELECT MAX(BATCH_SEQ) FROM DQ_CLEANSE_RESULTS WHERE DOMAIN_NAME = 'HR')))
     ) PCR
LEFT JOIN APPS.PER_ALL_PEOPLE_F PAPF ON PAPF.PERSON_ID = PCR.PERSON_ID AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
LEFT JOIN APPS.FND_LOOKUP_VALUES LKUP ON LKUP.LOOKUP_CODE = PCR.CONTACT_TYPE
                                      AND LKUP.LOOKUP_TYPE = 'CONTACT'
                                      AND LKUP.ZD_EDITION_NAME = 'SET1'
ORDER BY PAIR_GROUP, SIDE;
