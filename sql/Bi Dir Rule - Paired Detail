-- Bidirectional Relationships - Paired Detail
-- Shows both directions of each relationship, ordered so pairs appear together
WITH bidir_pairs AS (
    SELECT
        T.PERSON_ID,
        T.CONTACT_PERSON_ID,
        T.CONTACT_TYPE,
        LEAST(T.PERSON_ID, T.CONTACT_PERSON_ID) AS PAIR_LOW,
        GREATEST(T.PERSON_ID, T.CONTACT_PERSON_ID) AS PAIR_HIGH
    FROM DQ_PER_CONTACT_RELATIONSHIPS_V T
    JOIN APPS.PER_CONTACT_RELATIONSHIPS R
      ON R.PERSON_ID = T.CONTACT_PERSON_ID
     AND R.CONTACT_PERSON_ID = T.PERSON_ID
)
SELECT
    BP.PAIR_LOW || '-' || BP.PAIR_HIGH AS PAIR_ID,
    PAPF.FULL_NAME || ' has ' || PAPF2.FULL_NAME || ' as ' || L.MEANING AS RELATIONSHIP,
    BP.PERSON_ID,
    PAPF.FULL_NAME AS PERSON_NAME,
    BP.CONTACT_PERSON_ID,
    PAPF2.FULL_NAME AS CONTACT_NAME,
    L.MEANING AS CONTACT_TYPE_MEANING
FROM bidir_pairs BP
LEFT JOIN APPS.PER_ALL_PEOPLE_F PAPF
  ON PAPF.PERSON_ID = BP.PERSON_ID
 AND TRUNC(SYSDATE) BETWEEN PAPF.EFFECTIVE_START_DATE AND PAPF.EFFECTIVE_END_DATE
LEFT JOIN APPS.PER_ALL_PEOPLE_F PAPF2
  ON PAPF2.PERSON_ID = BP.CONTACT_PERSON_ID
 AND TRUNC(SYSDATE) BETWEEN PAPF2.EFFECTIVE_START_DATE AND PAPF2.EFFECTIVE_END_DATE
LEFT JOIN APPS.FND_LOOKUP_VALUES L
  ON L.LOOKUP_CODE = BP.CONTACT_TYPE
 AND L.LOOKUP_TYPE = 'CONTACT'
 AND L.ZD_EDITION_NAME = 'SET1'
ORDER BY BP.PAIR_LOW, BP.PAIR_HIGH, BP.PERSON_ID;
