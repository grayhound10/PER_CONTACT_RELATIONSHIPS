-- Bidirectional Relationships Summary
-- Simple view: Person → Contact → What they are to each other
WITH latest_batch AS (
    SELECT MAX(BATCH_SEQ) AS BATCH_SEQ
    FROM DQ_CLEANSE_RESULTS
    WHERE DOMAIN_NAME = 'HR'
),
cleanse_hits AS (
    SELECT R.TABROWID
    FROM DQ_CLEANSE_RESULTS R
    JOIN latest_batch LB ON LB.BATCH_SEQ = R.BATCH_SEQ
    WHERE R.PROCEDURE_NAME = 'DQ_EXISTS'
      AND R.FIELD_NAME = 'DQ_PERSON_ID'
      AND R.TABLE_NAME = 'PER_CONTACT_RELATIONSHIPS'
)
SELECT
    P1.PERSON_ID,
    PAPF1.EMPLOYEE_NUMBER,
    PAPF1.FULL_NAME AS PERSON_NAME,
    P1.CONTACT_PERSON_ID,
    PAPF2.EMPLOYEE_NUMBER AS CONTACT_EMPLOYEE_NUMBER,
    PAPF2.FULL_NAME AS CONTACT_NAME,
    L1.MEANING AS CONTACT_IS_THEIR,
    L2.MEANING AS PERSON_IS_CONTACTS
FROM cleanse_hits CH
JOIN DQ_PER_CONTACT_RELATIONSHIPS_V P1
  ON TO_CHAR(P1.TABROWID) = TO_CHAR(CH.TABROWID)
JOIN DQ_PER_CONTACT_RELATIONSHIPS_V P2
  ON P2.PERSON_ID = P1.CONTACT_PERSON_ID
 AND P2.CONTACT_PERSON_ID = P1.PERSON_ID
LEFT JOIN APPS.PER_ALL_PEOPLE_F PAPF1
  ON PAPF1.PERSON_ID = P1.PERSON_ID
 AND TRUNC(SYSDATE) BETWEEN PAPF1.EFFECTIVE_START_DATE AND PAPF1.EFFECTIVE_END_DATE
LEFT JOIN APPS.PER_ALL_PEOPLE_F PAPF2
  ON PAPF2.PERSON_ID = P1.CONTACT_PERSON_ID
 AND TRUNC(SYSDATE) BETWEEN PAPF2.EFFECTIVE_START_DATE AND PAPF2.EFFECTIVE_END_DATE
LEFT JOIN APPS.FND_LOOKUP_VALUES L1
  ON L1.LOOKUP_CODE = P1.CONTACT_TYPE
 AND L1.LOOKUP_TYPE = 'CONTACT'
 AND L1.ZD_EDITION_NAME = 'SET1'
LEFT JOIN APPS.FND_LOOKUP_VALUES L2
  ON L2.LOOKUP_CODE = P2.CONTACT_TYPE
 AND L2.LOOKUP_TYPE = 'CONTACT'
 AND L2.ZD_EDITION_NAME = 'SET1'
ORDER BY P1.PERSON_ID, P1.CONTACT_PERSON_ID;
